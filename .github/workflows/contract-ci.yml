name: contract-ci

on:
  pull_request:
    paths:
      - 'contracts/openapi/**'
      - 'scripts/**'
      - '.spectral.yaml'
      - '.github/workflows/contract-ci.yml'
      - 'apps/api/src/openapi-route-manifest.ts'
  push:
    branches: [main]
    paths:
      - 'contracts/openapi/**'
      - 'scripts/**'
      - '.spectral.yaml'
      - 'apps/api/src/openapi-route-manifest.ts'

jobs:
  contracts:
    runs-on: ubuntu-latest
    env:
      TEST_OFFLINE: ${{ vars.TEST_OFFLINE || '0' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24.13.1'
      - name: Verify Node version pin
        run: |
          test "$(node -v)" = "v24.13.1"
          echo "Node version OK: $(node -v)"
      - name: Verify required contract scripts exist
        run: |
          test -f scripts/validate-openapi.mjs
          test -f scripts/check-breaking-api.mjs
          test -f scripts/check-openapi-coverage.mjs
      - name: Lint OpenAPI
        run: npm run contract:lint
      - name: Breaking change gate (placeholder interface)
        run: npm run contract:breaking
      - name: OpenAPI route coverage gate
        run: npm run contract:coverage
